name: Content Airlock Pipeline

on:
  schedule:
    - cron: '0 8 * * *'      # Daily at 8 AM UTC (RSS + Email poll)
    - cron: '0 20 * * 5'     # Friday 8 PM UTC (Weekly bundle)
  workflow_dispatch:          # Manual trigger

jobs:
  poll-sources:
    if: github.event.schedule == '0 8 * * *' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      STORAGE_REPO: ${{ secrets.STORAGE_REPO }}
    permissions:
      contents: write
    steps:
      - name: Verify Repository is Private
        run: |
          if [ "${{ github.event.repository.private }}" != "true" ]; then
            echo "❌ ERROR: This workflow only runs on PRIVATE repositories for privacy reasons."
            echo "This workflow processes personal emails and browsing history."
            echo ""
            echo "Please make your repository private to use automation features."
            echo "Go to: Settings → General → Danger Zone → Change visibility → Make private"
            exit 1
          fi
          echo "✅ Repository is private. Proceeding with workflow..."
      
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - run: pip install -r requirements.txt
      
      - name: Checkout Private Storage (Optional)
        if: env.STORAGE_REPO != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.STORAGE_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: storage
          
      - name: Poll Email Inbox
        run: |
          if [ -n "$STORAGE_REPO" ]; then
            python -m src.email_ingestion --data-dir storage/data || echo "Email ingestion skipped (not configured)"
          else
            python -m src.email_ingestion || echo "Email ingestion skipped (not configured)"
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AIRLOCK_EMAIL: ${{ secrets.AIRLOCK_EMAIL }}
          AIRLOCK_EMAIL_PASSWORD: ${{ secrets.AIRLOCK_EMAIL_PASSWORD }}
          AIRLOCK_IMAP_SERVER: ${{ secrets.AIRLOCK_IMAP_SERVER }}
          AIRLOCK_ALLOWED_SENDERS: ${{ secrets.AIRLOCK_ALLOWED_SENDERS }}
          AIRLOCK_EMAIL_FOLDER: ${{ secrets.AIRLOCK_EMAIL_FOLDER }}
          AIRLOCK_EMAIL_ACTION: ${{ secrets.AIRLOCK_EMAIL_ACTION }}
          AIRLOCK_EMAIL_UNREAD_ONLY: ${{ secrets.AIRLOCK_EMAIL_UNREAD_ONLY }}
          STORAGE_REPO: ${{ secrets.STORAGE_REPO }}

      - name: Poll RSS Feeds
        run: |
          if [ -n "$STORAGE_REPO" ]; then
            echo "Using private storage..."
            python -m src.poll_rss --data-dir storage/data
          else
            echo "Using local storage..."
            python -m src.poll_rss
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          STORAGE_REPO: ${{ secrets.STORAGE_REPO }}
          
      - name: Commit to Private Storage
        if: env.STORAGE_REPO != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: storage
          commit_message: "Auto: Daily ingestion (email + RSS)"
          file_pattern: 'data/*'
          
      - name: Commit to Local Repo
        if: env.STORAGE_REPO == ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto: Daily ingestion (email + RSS)"
          file_pattern: 'data/*'

  bundle-weekly:
    if: github.event.schedule == '0 20 * * 5' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      STORAGE_REPO: ${{ secrets.STORAGE_REPO }}
    permissions:
      contents: write
    steps:
      - name: Verify Repository is Private
        run: |
          if [ "${{ github.event.repository.private }}" != "true" ]; then
            echo "❌ ERROR: This workflow only runs on PRIVATE repositories for privacy reasons."
            echo "This workflow processes personal emails and browsing history."
            echo ""
            echo "Please make your repository private to use automation features."
            echo "Go to: Settings → General → Danger Zone → Change visibility → Make private"
            exit 1
          fi
          echo "✅ Repository is private. Proceeding with workflow..."
      
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - run: pip install -r requirements.txt
      
      - name: Checkout Private Storage (Optional)
        if: env.STORAGE_REPO != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.STORAGE_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: storage
      
      - name: Run Weekly Bundler
        run: |
          if [ -n "$STORAGE_REPO" ]; then
            mkdir -p storage/Digests
            python -m src.bundle --days 7 --data-dir storage/data --output-dir storage/Digests
          else
            python -m src.bundle --days 7
          fi
        env:
          STORAGE_REPO: ${{ secrets.STORAGE_REPO }}
        
      - name: Commit to Private Storage
        if: env.STORAGE_REPO != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: storage
          commit_message: "Auto: Weekly digest bundle"
          file_pattern: 'Digests/*'

      - name: Commit to Local Repo
        if: env.STORAGE_REPO == ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto: Weekly digest bundle"
          file_pattern: 'Digests/*'
